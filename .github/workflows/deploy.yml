name: Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'packages/wilson/**'
      - 'netlify.toml'
      - 'yarn.lock'
  workflow_dispatch:

jobs:
  # If, for whatever reason, the userland netlify deploy action doesn't
  # work anymore, this can be switched to build & deploy on netlify via
  # netlify.toml and waiting for netlify deployment with
  # https://github.com/marketplace/actions/wait-for-netlify-deployment
  # Netlify will
  #   - deploy a preview every time there is a PR to the main branch
  #     opened, synchronized or reopened
  #   - comment on that PR with the preview deploy URL
  deployPreview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.ref != 'refs/heads/main'

    steps:
      - uses: actions/checkout@v2

      - name: Wait for Netlify Deploy
        uses: probablyup/wait-for-netlify-action@3.2.0
        id: netlify
        with:
          site_id: ${{ secrets.NETLIFY_SITE_ID }}
        env:
          NETLIFY_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - run: mkdir /tmp/artifacts

      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v7
        id: lighthouse
        with:
          urls: |
            ${{ steps.netlify.outputs.url }}
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Comment on PR
        uses: actions/github-script@v4
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.RELEASE_TOKEN }}
          script: |
            const { issue: { number: issue_number, owner, repo }  } = context;
            github.issues.createComment({
              issue_number,
              owner,
              repo, 
              body: `
                # Link:
                ${JSON.parse('${{ steps.lighthouse.outputs.links }}')}! ðŸ‘‹
              `
            });